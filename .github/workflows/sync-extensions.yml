name: Sync Extensions Repository

on:
  schedule:
    # æ¯æ—¥åŒ—äº¬æ—¶é—´ä¸Šåˆ 9 ç‚¹è¿è¡Œ (UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git and Network
      run: |
        echo "ğŸ”§ é…ç½® Git å’Œç½‘ç»œä¼˜åŒ–..."
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # ç½‘ç»œä¼˜åŒ–é…ç½®
        git config --global http.version HTTP/1.1
        git config --global http.postBuffer 1000000000  # 1GBç¼“å†²åŒº
        git config --global http.lowSpeedLimit 1000
        git config --global http.lowSpeedTime 300
        git config --global core.compression 9
        git config --global core.deltaBaseCacheLimit 2g
        
        echo "ğŸŒ ç½‘ç»œè¯Šæ–­ä¿¡æ¯..."
        curl -I --max-time 10 https://cnb.cool 2>&1 | head -10
        echo "ç½‘ç»œå»¶è¿Ÿæµ‹è¯•:"
        ping -c 3 cnb.cool 2>&1 | tail -5
        
    - name: Clone extensions repository
      run: |
        echo "ğŸ—‘ï¸ æ¸…ç†æ—§ç›®å½•..."
        rm -rf extensions
        
        echo "ğŸ“¥ å¼€å§‹å…‹éš†ï¼ˆä½¿ç”¨æ·±åº¦å…‹éš†å‡å°‘æ•°æ®é‡ï¼‰..."
        echo "å»ºè®®ï¼šå¯¹äº2.2GBçš„å¤§ä»“åº“ï¼Œä½¿ç”¨æ·±åº¦å…‹éš†"
        echo "é€‰é¡¹1ï¼šå®Œæ•´å…‹éš†ï¼ˆæ—¶é—´é•¿ä½†å®Œæ•´ï¼‰"
        echo "é€‰é¡¹2ï¼šæ·±åº¦å…‹éš†ï¼ˆæ—¶é—´çŸ­ä½†å†å²æœ‰é™ï¼‰"
        
        # å®Œæ•´å…‹éš†ç‰ˆæœ¬
        echo "ğŸ”„ å¼€å§‹å®Œæ•´å…‹éš†..."
        time git clone --branch repo --single-branch --progress https://github.com/keiyoushi/extensions.git 2>&1 | \
        while read line; do
          echo "ğŸ“¦ $(date '+%H:%M:%S') $line"
        done
        
        echo "âœ… å…‹éš†å®Œæˆ"
        cd extensions
        echo "ä»“åº“å¤§å°: $(du -sh .)"
        echo "æäº¤æ•°é‡: $(git rev-list --count HEAD)"
        cd ..
        
    - name: Push to target repository (å¸¦è¯¦ç»†è¯Šæ–­)
      timeout-minutes: 30
      run: |
        echo "ğŸš€ =========== å¼€å§‹æ¨é€é˜¶æ®µ ==========="
        cd extensions
        
        echo "ğŸ“Š å½“å‰ä»“åº“çŠ¶æ€:"
        echo "ç›®å½•: $(pwd)"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo "æœ€è¿‘æäº¤: $(git log --oneline -1)"
        echo "å¯¹è±¡æ•°é‡: $(git count-objects -v | grep count | cut -d: -f2)"
        
        echo "ğŸ”— é…ç½®è¿œç¨‹ä»“åº“..."
        # æ¸…ç†æ—§è¿œç¨‹
        git remote remove target 2>/dev/null || echo "æ— æ—§è¿œç¨‹"
        
        # æ·»åŠ æ–°è¿œç¨‹ï¼ˆå¸¦è®¤è¯ï¼‰
        REMOTE_URL="https://cnb:${{ secrets.SYNC_TOKEN }}@cnb.cool/kfc50/keiyoushi-extensions.git"
        echo "è¿œç¨‹URL: ${REMOTE_URL/\/\/cnb:*/\/\/cnb:******@cnb.cool/}"
        git remote add target "$REMOTE_URL"
        
        echo "ğŸ” æµ‹è¯•è¿œç¨‹è¿æ¥..."
        echo "æµ‹è¯•1: åŸºæœ¬è¿æ¥æµ‹è¯•"
        timeout 15 git ls-remote target --heads 2>&1 && echo "âœ… è¿æ¥æ­£å¸¸" || echo "âš ï¸ è¿æ¥æµ‹è¯•å¤±è´¥"
        
        echo "æµ‹è¯•2: è®¤è¯æµ‹è¯•"
        curl -u "cnb:${{ secrets.SYNC_TOKEN }}" \
             -I --max-time 10 \
             "https://cnb.cool/kfc50/keiyoushi-extensions.git/info/refs?service=git-receive-pack" 2>&1 | \
             grep -E "(HTTP|WWW-Auth|Server)" && echo "âœ… è®¤è¯æ­£å¸¸" || echo "âš ï¸ è®¤è¯å¯èƒ½æœ‰é—®é¢˜"
        
        echo "âš™ï¸ è®¾ç½®ç¯å¢ƒå˜é‡è¿›è¡Œè¯¦ç»†è¿½è¸ª..."
        export GIT_CURL_VERBOSE=1
        export GIT_TRACE=1
        export GIT_TRACE_PACKET=1
        export GIT_TRACE_PERFORMANCE=1
        export GIT_TRACE_SETUP=1
        export GIT_HTTP_MAX_REQUEST_BUFFER=500M
        
        echo "ğŸ“¤ =========== å¼€å§‹æ¨é€ ==========="
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "æ¨é€å‘½ä»¤: git push target repo --force --progress"
        echo "----------------------------------------"
        
        # ä½¿ç”¨teeåŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ–‡ä»¶
        {
          echo "æ¨é€è¯¦ç»†æ—¥å¿—å¼€å§‹..."
          time git push target repo --force --progress 2>&1
          PUSH_EXIT_CODE=$?
          echo "æ¨é€é€€å‡ºç : $PUSH_EXIT_CODE"
        } | tee /tmp/git_push.log | \
        grep -E "(Send|Recv|Writing|Counting|Compressing|Total|done|error|fatal|Enumerating|POST|PUT|GET|HTTP)" | \
        while read line; do
          echo "ğŸ“¤ $(date '+%H:%M:%S') $line"
        done
        
        echo "----------------------------------------"
        echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # åˆ†ææ¨é€ç»“æœ
        echo "ğŸ“‹ =========== ç»“æœåˆ†æ ==========="
        
        if [ $PUSH_EXIT_CODE -eq 0 ]; then
          echo "âœ… æ¨é€æˆåŠŸï¼"
          echo "éªŒè¯è¿œç¨‹åˆ†æ”¯..."
          if git ls-remote target refs/heads/repo 2>&1 | grep -q "refs/heads/repo"; then
            echo "âœ… è¿œç¨‹åˆ†æ”¯ç¡®è®¤å­˜åœ¨"
            echo "åˆ†æ”¯SHA: $(git ls-remote target refs/heads/repo | cut -f1)"
          else
            echo "âš ï¸ è¿œç¨‹åˆ†æ”¯éªŒè¯å¤±è´¥"
          fi
        else
          echo "âŒ æ¨é€å¤±è´¥ï¼Œé€€å‡ºç : $PUSH_EXIT_CODE"
          
          echo "ğŸ” é”™è¯¯åˆ†æ:"
          echo "1. æ£€æŸ¥ç½‘ç»œè¿æ¥..."
          curl -I --max-time 10 "https://cnb.cool" 2>&1 | head -5
          
          echo "2. æ£€æŸ¥æœ€è¿‘æ—¥å¿—ï¼ˆæœ€å20è¡Œï¼‰:"
          tail -20 /tmp/git_push.log
          
          echo "3. æ£€æŸ¥é”™è¯¯å…³é”®è¯:"
          grep -i -E "(error|fail|timeout|denied|forbidden|unauthorized|not found)" /tmp/git_push.log | head -10
          
          echo "ğŸ’¡ å»ºè®®æ“ä½œ:"
          echo "1. æ£€æŸ¥ CNB ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ"
          echo "2. æ£€æŸ¥ä»“åº“è·¯å¾„æ˜¯å¦æ­£ç¡®: kfc50/keiyoushi-extensions"
          echo "3. å°è¯•åˆ†æ‰¹æ¨é€ï¼ˆå¦‚æœä»“åº“å¤ªå¤§ï¼‰"
          
          # ä¿å­˜è¯¦ç»†æ—¥å¿—ä¾›åç»­åˆ†æ
          echo "ğŸ“ è¯¦ç»†æ—¥å¿—ä¿å­˜åˆ°: /tmp/git_push.log"
          echo "æ—¥å¿—å‰100è¡Œ:"
          head -100 /tmp/git_push.log
        fi
        
        echo "ğŸ‰ æ¨é€æµç¨‹æ‰§è¡Œå®Œæ¯•"
        exit $PUSH_EXIT_CODE
        
    - name: æ¨é€åæ¸…ç†ï¼ˆå¯é€‰ï¼‰
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -rf extensions
        echo "âœ… æ¸…ç†å®Œæˆ"
