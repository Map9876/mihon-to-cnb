name: Sync Extensions Repository

on:
  schedule:
    # æ¯æ—¥åŒ—äº¬æ—¶é—´ä¸Šåˆ 9 ç‚¹è¿è¡Œ (UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git
      run: |
        echo "ğŸ”§ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        echo "âœ… Git é…ç½®å®Œæˆ"
        
    - name: Clone extensions repository
      run: |
        echo "ğŸ—‘ï¸ æ¸…ç†æ—§ç›®å½•..."
        rm -rf extensions
        
        echo "ğŸ“¥ å¼€å§‹å…‹éš† extensions ä»“åº“çš„ repo åˆ†æ”¯..."
        echo "ä»“åº“åœ°å€: https://github.com/keiyoushi/extensions.git"
        echo "ç›®æ ‡åˆ†æ”¯: repo"
        
        git clone --branch repo --single-branch --progress https://github.com/keiyoushi/extensions.git 2>&1 | while read line; do
          echo "ğŸ“¦ $line"
        done
        
        echo "âœ… å…‹éš†å®Œæˆ"
        
    - name: Push to target repository
      timeout-minutes: 10  # è®¾ç½®10åˆ†é’Ÿè¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
      run: |
        echo "ğŸš€ å¼€å§‹æ¨é€æ­¥éª¤"
        cd extensions
        
        echo "=== æ­¥éª¤ 1: éªŒè¯å½“å‰çŠ¶æ€ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
        echo "æœ€è¿‘æäº¤: $(git log --oneline -1)"
        
        echo "=== æ­¥éª¤ 2: é…ç½®è¿œç¨‹ä»“åº“ ==="
        # å…ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§è¿œç¨‹
        git remote remove target 2>/dev/null || echo "æ— æ—§è¿œç¨‹éœ€è¦åˆ é™¤"
        
        # æ·»åŠ æ–°çš„è¿œç¨‹ä»“åº“ï¼ˆä½¿ç”¨å¸¦è®¤è¯çš„URLï¼‰
        echo "æ·»åŠ è¿œç¨‹: cnb.cool/kfc50/keiyoushi-extensions.git"
        git remote add target https://cnb:${{ secrets.SYNC_TOKEN }}@cnb.cool/kfc50/keiyoushi-extensions.git
        
        echo "è¿œç¨‹åˆ—è¡¨:"
        git remote -v
        
        echo "=== æ­¥éª¤ 3: æµ‹è¯•ç½‘ç»œè¿æ¥ ==="
        echo "æµ‹è¯•ä»“åº“å¯è®¿é—®æ€§..."
        timeout 30 git ls-remote target --heads 2>&1 && echo "âœ… ä»“åº“å¯è®¿é—®" || echo "âš ï¸ ä»“åº“è®¿é—®æµ‹è¯•å¤±è´¥"
        
        echo "=== æ­¥éª¤ 4: å¼€å§‹æ¨é€ ==="
        echo "æ¨é€å‘½ä»¤: git push target repo --force --progress"
        echo "å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # ä½¿ç”¨è¯¦ç»†æ¨¡å¼æ¨é€å¹¶å®æ—¶è¾“å‡º
        GIT_TRACE=1 GIT_CURL_VERBOSE=1 GIT_TRACE_PERFORMANCE=1 git push target repo --force --progress 2>&1 | while read line; do
          echo "ğŸ“¤ $(date '+%H:%M:%S') $line"
        done
        
        PUSH_EXIT_CODE=${PIPESTATUS[0]}
        
        echo "=== æ­¥éª¤ 5: éªŒè¯ç»“æœ ==="
        echo "ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "æ¨é€é€€å‡ºç : $PUSH_EXIT_CODE"
        
        if [ $PUSH_EXIT_CODE -eq 0 ]; then
          echo "âœ… æ¨é€æˆåŠŸï¼"
          echo "éªŒè¯è¿œç¨‹åˆ†æ”¯..."
          git ls-remote target refs/heads/repo 2>&1 && echo "âœ… è¿œç¨‹åˆ†æ”¯ç¡®è®¤å­˜åœ¨" || echo "âš ï¸ è¿œç¨‹åˆ†æ”¯éªŒè¯å¤±è´¥"
        else
          echo "âŒ æ¨é€å¤±è´¥ï¼Œé€€å‡ºç : $PUSH_EXIT_CODE"
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "1. æ£€æŸ¥ç½‘ç»œ:"
          curl -I --max-time 10 https://cnb.cool 2>&1 | head -5
          echo "2. æ£€æŸ¥ç›®å½•:"
          ls -la
          echo "3. Git çŠ¶æ€:"
          git status --short
          exit 1
        fi
        
        echo "ğŸ‰ åŒæ­¥æµç¨‹å®Œæˆï¼"
